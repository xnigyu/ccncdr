<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>雨量趨勢圖</title>
    <script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>
    <script type="text/javascript">
        google.charts.load('current', {'packages':['corechart']});
        google.charts.setOnLoadCallback(drawChart);

        function getParameterByName(name, url = window.location.href) {
            name = name.replace(/[\[\]]/g, '\\$&');
            var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
                results = regex.exec(url);
            if (!results) return null;
            if (!results[2]) return '';
            return decodeURIComponent(results[2].replace(/\+/g, ' '));
        }

        function drawChart() {
            var jsonFile = getParameterByName('file') || 'data/prcp_pastTrend_Changhua.json';

            var xhr = new XMLHttpRequest();
            xhr.open('GET', jsonFile, true);
            xhr.responseType = 'json';
            xhr.onload = function() {
                if (xhr.status === 200) {
                    var jsonData = xhr.response;
                    processData(jsonData);
                } else {
                    console.error('Failed to load data');
                }
            };
            xhr.send();
        }

        function processData(jsonData) {
            var data = new google.visualization.DataTable();
            data.addColumn('number', '年份');
            data.addColumn('number', '雨量(>平均值)');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn('number', '雨量(<平均值)');
            data.addColumn({type: 'string', role: 'style'});
            data.addColumn('number', '9年移動平均');
            data.addColumn('number', '線性趨勢');

            var avgRain = parseFloat(jsonData.DataList[0].AvgRain);
            var avgRain2 = Math.round(avgRain / 500) * 500;

            jsonData.DataList.forEach(function(row) {
                var rain = parseFloat(row.Rain);
                var aboveAvg = rain >= avgRain ? rain : null;
                var belowAvg = rain < avgRain ? rain : null;

                data.addRow([
                    parseInt(row.Year),
                    aboveAvg, aboveAvg ? '#66CCCC' : null, // 青色
                    belowAvg, belowAvg ? '#99D8B7' : null, // 淡綠色
                    row['9yrRun'] ? parseFloat(row['9yrRun']) : null,
                    parseFloat(row.Trend)
                ]);
            });

            var options = {
                width: '100%',
                height: '100%',
                chartArea: {
                    width: '86%',
                    height: '65%',
                    left: 50,
                    bottom: 50
                },
                legend: {position: 'top', textStyle: { fontSize: 16, color: '#333', bold: true }},
                vAxis: {
                    title: '雨量 (毫米)',
                    titleTextStyle: { fontSize: 13, bold: true },
                    textStyle: { fontSize: 14, bold: true },
                    format: '#.#',
                    baseline: avgRain,
                    baselineColor: '#ccc',
                    ticks: [
                        {v: avgRain2 - 1500, f: (avgRain2 - 1500).toFixed(0)},
                        {v: avgRain2 - 1000, f: (avgRain2 - 1000).toFixed(0)},    
                        {v: avgRain2 - 500, f: (avgRain2 - 500).toFixed(0)},
                        {v: avgRain, f: avgRain.toFixed(0)},
                        {v: avgRain2 + 500, f: (avgRain2 + 500).toFixed(0)},
                        {v: avgRain2 + 1000, f: (avgRain2 + 1000).toFixed(0)},
                        {v: avgRain2 + 1500, f: (avgRain2 + 1500).toFixed(0)}
                    ]
                },
                hAxis: {
                    title: '年份',
                    titleTextStyle: { fontSize: 16, bold: true },
                    textStyle: { fontSize: 16, bold: true },
                    format: '####'
                },
                bar: {
                    groupWidth: "100%"  // 設定柱狀圖寬度
                },
                series: {
                    0: {type: 'bars', color: '#66CCCC'}, // 雨量 ≥ 平均
                    1: {type: 'bars', color: '#99D8B7'}, // 雨量 ＜ 平均
                    2: {type: 'line', color: '#FF9966', lineDashStyle: [4, 4],lineWidth:2.5}, // 9年移動平均（橘色虛線）
                    3: {type: 'line', color: '#800080', lineDashStyle: [4, 4],lineWidth:2.5}  // 線性趨勢（紫色虛線）
                }
            };

            var chart = new google.visualization.ComboChart(document.getElementById('chart_div'));
            var formatter = new google.visualization.NumberFormat({ pattern: '####' });
            formatter.format(data, 0);
            var tempFormatter = new google.visualization.NumberFormat({ pattern: '#,##0.0' });
            tempFormatter.format(data, 1);
            tempFormatter.format(data, 3);
            tempFormatter.format(data, 5);
            tempFormatter.format(data, 6);

            function resizeChart() {
                var chartDiv = document.getElementById('chart_div');
                var parentWidth = chartDiv.parentElement.offsetWidth;
                var parentHeight = chartDiv.parentElement.offsetHeight;
                var width = Math.max(parentWidth, 400);
                var height = Math.max(parentHeight, 230);
                chart.draw(data, {...options, width: width, height: height});
            }

            window.addEventListener('resize', resizeChart);
            resizeChart();
        }
    </script>
    <style>
        html, body, #chart_div {
            width: 100%;
            height: 100%;
            align-items: center;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }
    </style>
</head>
<body>
    <div id="chart_div"></div>
</body>
</html>
